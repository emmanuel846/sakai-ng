<div class="grid">
    <div class="col-12">
        <div class="card">
            <h3>Gestion des Points de Collecte</h3>
            
            <p-toast></p-toast>
            <p-confirmDialog></p-confirmDialog>
            
            <div class="p-toolbar-group-start mb-3">
                <p-button 
                    label="Nouveau Point de Collecte" 
                    icon="pi pi-plus" 
                    class="p-button-success mr-2"
                    (click)="openNewCollectionPoint()">
                </p-button>
                <p-dropdown 
                    [options]="countryOptions" 
                    placeholder="Filtrer par pays"
                    optionLabel="label"
                    optionValue="value"
                    [showClear]="true"
                    (onChange)="onCountryFilterChange($event)"
                    class="ml-2">
                </p-dropdown>
            </div>

            <p-table 
                [value]="filteredCollectionPoints" 
                [loading]="loading"
                [paginator]="true" 
                [rows]="10"
                [globalFilterFields]="['name', 'adresse', 'country', 'contacts']"
                responsiveLayout="scroll"
                #dt>
                
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between align-items-center">
                        <h5 class="m-0">
                            Liste des Points de Collecte
                            <span *ngIf="selectedCountryForFilter"> - {{ selectedCountryForFilter.name }}</span>
                        </h5>
                        <span class="p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input 
                                pInputText 
                                type="text" 
                                (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                                placeholder="Rechercher..." />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="name">
                            Nom <p-sortIcon field="name"></p-sortIcon>
                        </th>
                        <th pSortableColumn="country">
                            Pays <p-sortIcon field="country"></p-sortIcon>
                        </th>
                        <th pSortableColumn="adresse">
                            Adresse <p-sortIcon field="adresse"></p-sortIcon>
                        </th>
                        <th pSortableColumn="contacts">
                            Contacts <p-sortIcon field="contacts"></p-sortIcon>
                        </th>
                        <th pSortableColumn="openHours">
                            Horaires <p-sortIcon field="openHours"></p-sortIcon>
                        </th>
                        <th pSortableColumn="status">
                            Statut <p-sortIcon field="status"></p-sortIcon>
                        </th>
                        <th>Actions</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-collectionPoint>
                    <tr>
                        <td>{{ collectionPoint.name }}</td>
                        <td>{{ collectionPoint.country }}</td>
                        <td>{{ collectionPoint.adresse }}</td>
                        <td>{{ collectionPoint.contacts }}</td>
                        <td>{{ collectionPoint.openHours }}</td>
                        <td>
                            <span [class]="'badge ' + (collectionPoint.status === 'ACTIVATED' ? 'badge-success' : 'badge-warning')">
                                {{ collectionPoint.status || 'N/A' }}
                            </span>
                        </td>
                        <td>
                            <p-button 
                                *ngIf="getLocationUrl(collectionPoint)"
                                icon="pi pi-map-marker" 
                                class="p-button-rounded p-button-info mr-2"
                                (click)="openLocationInNewTab(collectionPoint)"
                                pTooltip="Voir sur la carte"
                                tooltipPosition="top">
                            </p-button>
                            <p-button 
                                icon="pi pi-pencil" 
                                class="p-button-rounded p-button-success mr-2"
                                (click)="editCollectionPoint(collectionPoint)"
                                pTooltip="Modifier"
                                tooltipPosition="top">
                            </p-button>
                            <p-button 
                                icon="pi pi-trash" 
                                class="p-button-rounded p-button-warning"
                                (click)="deleteCollectionPoint(collectionPoint)"
                                pTooltip="Supprimer"
                                tooltipPosition="top">
                            </p-button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<!-- DIALOG POINT DE COLLECTE -->
<p-dialog 
    [(visible)]="collectionPointDialog" 
    [modal]="true" 
    [header]="(editingCollectionPoint ? 'Modifier' : 'Nouveau') + ' Point de Collecte'" 
    [closable]="false"
    class="p-fluid"
    [style]="{ width: '600px' }">
    
    <ng-template pTemplate="content">
        <form [formGroup]="collectionPointForm">
            <div class="field">
                <label for="name">Nom du Point de Collecte *</label>
                <input 
                    type="text" 
                    pInputText 
                    id="name" 
                    formControlName="name"
                    [class.ng-invalid]="collectionPointForm.get('name')?.invalid && collectionPointForm.get('name')?.touched" />
                <small class="p-invalid" *ngIf="collectionPointForm.get('name')?.invalid && collectionPointForm.get('name')?.touched">
                    Le nom est requis.
                </small>
            </div>

            <div class="field">
                <label for="country">Pays *</label>
                <p-dropdown 
                    [options]="countryOptions" 
                    formControlName="country"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Sélectionner un pays"
                    [class.ng-invalid]="collectionPointForm.get('country')?.invalid && collectionPointForm.get('country')?.touched">
                </p-dropdown>
                <small class="p-invalid" *ngIf="collectionPointForm.get('country')?.invalid && collectionPointForm.get('country')?.touched">
                    Le pays est requis.
                </small>
            </div>

            <div class="field">
                <label for="adresse">Adresse *</label>
                <textarea 
                    pInputTextarea 
                    id="adresse" 
                    formControlName="adresse"
                    rows="3"
                    placeholder="Adresse complète du point de collecte"
                    [class.ng-invalid]="collectionPointForm.get('adresse')?.invalid && collectionPointForm.get('adresse')?.touched">
                </textarea>
                <small class="p-invalid" *ngIf="collectionPointForm.get('adresse')?.invalid && collectionPointForm.get('adresse')?.touched">
                    L'adresse est requise.
                </small>
            </div>

            <div class="field">
                <label for="google_location_url">URL Google Maps *</label>
                <input 
                    type="url" 
                    pInputText 
                    id="google_location_url" 
                    formControlName="google_location_url"
                    placeholder="https://maps.google.com/..."
                    [class.ng-invalid]="collectionPointForm.get('google_location_url')?.invalid && collectionPointForm.get('google_location_url')?.touched" />
                <small class="p-invalid" *ngIf="collectionPointForm.get('google_location_url')?.invalid && collectionPointForm.get('google_location_url')?.touched">
                    L'URL Google Maps est requise.
                </small>
            </div>

            <div class="field">
                <label for="contacts">Contacts *</label>
                <textarea 
                    pInputTextarea 
                    id="contacts" 
                    formControlName="contacts"
                    rows="2"
                    placeholder="Numéros de téléphone, emails..."
                    [class.ng-invalid]="collectionPointForm.get('contacts')?.invalid && collectionPointForm.get('contacts')?.touched">
                </textarea>
                <small class="p-invalid" *ngIf="collectionPointForm.get('contacts')?.invalid && collectionPointForm.get('contacts')?.touched">
                    Les contacts sont requis.
                </small>
            </div>

            <div class="field">
                <label for="openHours">Heures d'ouverture *</label>
                <textarea 
                    pInputTextarea 
                    id="openHours" 
                    formControlName="openHours"
                    rows="2"
                    placeholder="Ex: Lun-Ven: 9h-17h, Sam: 9h-12h"
                    [class.ng-invalid]="collectionPointForm.get('openHours')?.invalid && collectionPointForm.get('openHours')?.touched">
                </textarea>
                <small class="p-invalid" *ngIf="collectionPointForm.get('openHours')?.invalid && collectionPointForm.get('openHours')?.touched">
                    Les heures d'ouverture sont requises.
                </small>
            </div>
        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <p-button 
            label="Annuler" 
            icon="pi pi-times" 
            class="p-button-text"
            (click)="hideDialog()">
        </p-button>
        <p-button 
            label="Sauvegarder" 
            icon="pi pi-check" 
            class="p-button-text"
            [disabled]="collectionPointForm.invalid"
            (click)="saveCollectionPoint()">
        </p-button>
    </ng-template>
</p-dialog>
